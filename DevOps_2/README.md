## Задачи
1. Написать "плохой" `Dockerfile`, в котором есть не менее трех "bad practices" по написанию докерфайлов
2. Написать "хороший" `Dockerfile`, в котором эти плохие практики исправлены
3. В `Readme` описать каждую из плохих практик в плохом докерфайле, почему она плохая и как в хорошем она была исправлена, как исправление повлияло на результат
4. В `Readme` описать 2 плохих практики по работе с контейнерами. ! Не по написанию докерфайлов, а о том, как даже используя хороший докерфайл можно накосячить именно в работе с контейнерами.
## "Плохой" `Dockerfile`
Основная идея создания докерфайла - развернуть в контейнере проект из предыдущей [лабы](https://github.com/dymonyx/itmo-cloud-devops/tree/main/DevOps_1) с помощью `nginx`. Вот, кстати, его содержимое:
```
FROM ubuntu:latest

RUN apt-get update
RUN apt-get install -y nginx
RUN rm /var/www/html/index.nginx-debian.html

COPY static/index.html /var/www/html/
COPY script.js /var/www/html/
COPY static/style.css /var/www/html/

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]

```
Разберём, что же тут не так.
1. Для наших задач образ `ubuntu` избыточен, нам нужен только рабочий `nginx`, т.е абсолютное большинство утилит, которое входит в выбранный образ, просто бесполезно в нашем случае. Из-за этого образ будет загружаться дольше, т.к его размер будет велик, а также всё, что является избыточным, увеличит количество уязвимостей для атак нашего контейнера.
2. В качестве версии образа указан тег `latest`, что является `bad practise` из-за того, что при выходе новой версии образа `ubuntu` тег будет указывать на совсем другой образ и докерфайл начнёт его использовать именно его (а не тот, что был до этого). Проблема в том, что новый образ может быть несовместим с нашим проектом и вызвать неожиданные ошибки. 
3. Каждая команда `RUN` создаёт отдельный слой, что замедляет процесс сборки образа и утяжеляет его. Более того, команды `update` и `install` следует выполнять в одной команде `RUN`, потому что если в будущем мы захотим установить ещё какой-то пакет и перепишем для этого докерфайл, то `update` пропустится, взявшись из кэша и из-за этого могут установиться не самые новые пакеты.
4. В докерфайле часто повторяется один и тот же путь `/var/www/html/`, с точки зрения читаемости докерфайла и отсутствия явного обозначения, где лежит основная часть нашего проекта, это плохо.
## "Хороший" `Dockerfile`
Ознакомимся с содержимым:
```
FROM nginx:1.27.2-alpine

WORKDIR /usr/share/nginx/html/

RUN rm index.html

COPY static/index.html .
COPY script.js .
COPY static/style.css .

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]

```
Разберём, что было исправлено.
1. Избыточный образ `ubuntu` заменён на образ `nginx`(размер уменьшился почти в 3 раза).
![](img/Pasted%20image%2020241008175124.png)
2. Указана конкретная версия `1.27.2-alpine` для образа, что избавит нас от возможных внезапных ошибок, когда выйдет новая версия образа.
3. Так как образ уже содержит в себе необходимый нам `nginx`, то осталась единственная команда по удалению базового `html`-файла `nginx`, но в общем случае все команды `RUN` следовало бы переписать в одну, чтобы минимизировать количество слоёв: 
`RUN apt-get update && apt-get install -y nginx && rm /var/www/html/index.nginx-debian.html`
4. Использование `WORKDIR` для явного обозначения рабочей директории сделало докерфайл читабельней.
## Bad practices по работе с контейнерами
1. Изменение чего-либо в работающем контейнере не для дебага. Если нужно внести какие-то корректировки, стоит переписать докерфайл и создать новый контейнер на его основе. В противном случае, после перезапуска все изменения внутри контейнера сотрутся.
2. Не ограничивать ресурсы. По дефолту докер не ограничивает ресурсы, выделяемые контейнеру, поэтому он может использовать все ресурсы, что есть у хоста, что может привести к замедлению его работы.
## Пруфы, что докерфайлы рабочие
На основе обоих докерфайлов были созданы контейнеры. Проверим, работает ли наш проект. Контейнер с "плохим" докерфайлом привязан к 8081 порту, а с "хорошим" к 8080.
![](img/Pasted%20image%2020241008132237.png)
![](img/Pasted%20image%2020241008132154.png)
![](img/Pasted%20image%2020241008132205.png)

## Использованные источники
[best practices](https://dev.to/kalkwst/dockerfile-best-practices-explained-interlude-post-2-3elj)
[best practices from dockerdocs](https://docs.docker.com/build/building/best-practices/)
[nginx base image](https://hub.docker.com/_/nginx)

## P.S.
Можно было заметить, что директории, используемые в докерфайлах различаются. Оказалось, что папки, в которых содержится дефолтный `html`-файл для `nginx`, разные для разных образов (для меня это не было очевидным), поэтому пришлось чуть скорректировать пути и только поэтому они отличаются - больше никакого практического смысла эта замена не несёт.